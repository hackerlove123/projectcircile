version: 2.1

workflows:
  build:
    jobs:
      - system_check

jobs:
  system_check:
    machine: true
    steps:
      - run:
          name: Kéo image Ubuntu Gnome VNC từ Docker Hub
          command: |
            sudo docker pull darkdragon001/ubuntu-gnome-vnc  # Tải image về trước khi chạy
      - run:
          name: Chạy container Ubuntu Gnome VNC
          command: |
            sudo docker run --name=ubuntu-gnome -d --rm \
              --tmpfs /run --tmpfs /run/lock --tmpfs /tmp \
              --cap-add SYS_BOOT --cap-add SYS_ADMIN \
              --cgroupns=host -v /sys/fs/cgroup:/sys/fs/cgroup \
              -p 5901:5901 -p 6901:6901 \
              darkdragon001/ubuntu-gnome-vnc  # Chạy container với các thiết lập phù hợp
      - run:
          name: Cài đặt ngrok
          command: |
            npm install -g ngrok  # Cài đặt ngrok toàn cầu bằng npm
      - run:
          name: Chạy máy chủ giả lập trên cổng 6091
          command: |
            nohup python3 -m http.server 6091 &  # Chạy một máy chủ HTTP đơn giản trên cổng 6091
      - run:
          name: Cấu hình và chạy ngrok
          command: |
            ngrok config add-authtoken 2uARyZ1iAmLrdb1iXHkh5RQv7QG_3y6HxJYXJXdCDtTQvgu3c  # Thêm mã xác thực
            ngrok http 6091 &  # Mở đường hầm HTTP trên cổng 6091 và giữ job luôn chạy
            sleep infinity  # Giữ job chạy vô hạn
